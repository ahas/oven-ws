{"version":3,"sources":["send.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","prototype","hasOwnProperty","call","TypeError","String","__","constructor","create","createError","dbg","destroy","encodeUrl","escapeHtml","etag","fresh","fs","mime","onFinished","parseRange","extname","join","normalize","resolve","sep","statuses","Stream","ms","debug","SendStream","_super","req","path","options","_this","opts","_acceptRanges","acceptRanges","undefined","Boolean","_cacheControl","cacheControl","_etag","_dotfiles","dotfiles","_extensions","extensions","normalizeList","_immutable","immutable","_index","index","_lastModified","lastModified","_maxAge","maxAge","Number","isNaN","Math","min","max","MAX_MAXAGE","_root","root","error","status","hasListeners","emit","expose","res","msg","message","doc","createHtmlDocument","clearHeaders","headers","setHeaders","statusCode","setHeader","Buffer","byteLength","end","hasTrailingSlash","length","isConditionalGET","isPreconditionFailure","match","etag_1","getHeader","parseTokenList","every","unmodifiedSince","parseHttpDate","removeContentHeaderFields","getHeaderNames","i","header","substr","removeHeader","notModified","headersAlreadySent","err","Error","isCachable","onStatError","code","isFresh","isRangeFresh","ifRange","indexOf","etag_2","redirect","loc","collapseLeadingSlashes","pipe","decodedPath","decode","parts","UP_PATH_REGEXP","test","split","containsDotFile","access","sendIndex","sendFile","send","stat","ranges","range","len","size","offset","start","headersSent","type","bytes","BYTES_RANGE_REGEXP","parsedRanges","combine","contentRange","name","prop","method","stream","self","onstat","next","isDirectory","finished","createReadStream","onfinished","on","onerror","onend","lookup","charset","floor","modified","mtime","toUTCString","val","str","part","title","body","decodeURIComponent","emitter","count","listenerCount","listeners","list","concat","date","timestamp","Date","parse","NaN","charCodeAt","push","substring","keys","key"],"mappings":"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","file":"send.js","sourcesContent":["var __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        if (typeof b !== \"function\" && b !== null)\r\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nimport createError from \"http-errors\";\r\nimport dbg from \"debug\";\r\nimport destroy from \"destroy\";\r\nimport encodeUrl from \"encodeurl\";\r\nimport escapeHtml from \"escape-html\";\r\nimport etag from \"etag\";\r\nimport fresh from \"fresh\";\r\nimport fs from \"fs\";\r\nimport mime from \"mime-types\";\r\nimport onFinished from \"on-finished\";\r\nimport parseRange from \"range-parser\";\r\nimport { extname, join, normalize, resolve, sep } from \"path\";\r\nimport statuses from \"statuses\";\r\nimport Stream from \"stream\";\r\nimport ms from \"ms\";\r\nvar debug = dbg(\"oven/ws:send\");\r\nvar SendStream = /** @class */ (function (_super) {\r\n    __extends(SendStream, _super);\r\n    function SendStream(req, path, options) {\r\n        var _this = _super.call(this) || this;\r\n        var opts = options || {};\r\n        _this.options = opts;\r\n        _this.path = path;\r\n        _this.req = req;\r\n        _this._acceptRanges = opts.acceptRanges !== undefined ? Boolean(opts.acceptRanges) : true;\r\n        _this._cacheControl = opts.cacheControl !== undefined ? Boolean(opts.cacheControl) : true;\r\n        _this._etag = opts.etag !== undefined ? Boolean(opts.etag) : true;\r\n        _this._dotfiles = opts.dotfiles;\r\n        if (_this._dotfiles !== \"ignore\" && _this._dotfiles !== \"allow\" && _this._dotfiles !== \"deny\") {\r\n            throw new TypeError('dotfiles option must be \"allow\", \"deny\", or \"ignore\"');\r\n        }\r\n        _this._extensions = opts.extensions !== undefined ? normalizeList(opts.extensions, \"extensions option\") : [];\r\n        _this._immutable = opts.immutable !== undefined ? Boolean(opts.immutable) : false;\r\n        _this._index = opts.index !== undefined ? normalizeList(opts.index, \"index option\") : [\"index.html\"];\r\n        _this._lastModified = opts.lastModified !== undefined ? Boolean(opts.lastModified) : true;\r\n        _this._maxAge = opts.maxAge;\r\n        _this._maxAge = typeof _this._maxAge === \"string\" ? ms(_this._maxAge) : Number(_this._maxAge);\r\n        _this._maxAge = !isNaN(_this._maxAge) ? Math.min(Math.max(0, _this._maxAge), MAX_MAXAGE) : 0;\r\n        _this._root = opts.root ? resolve(opts.root) : null;\r\n        return _this;\r\n    }\r\n    /**\r\n     * Set root `path`\r\n     * @param path a root path\r\n     * @returns\r\n     */\r\n    SendStream.prototype.root = function (path) {\r\n        this._root = resolve(String(path));\r\n        debug(\"root %s\", this._root);\r\n        return this;\r\n    };\r\n    /**\r\n     * Emit error with `status`.\r\n     */\r\n    SendStream.prototype.error = function (status, error) {\r\n        // emit if listeners instead of responding\r\n        if (hasListeners(this, \"error\")) {\r\n            this.emit(\"error\", createError(status, error, {\r\n                expose: false,\r\n            }));\r\n            return;\r\n        }\r\n        var res = this.res;\r\n        var msg = statuses.message[status] || String(status);\r\n        var doc = createHtmlDocument(\"Error\", escapeHtml(msg));\r\n        // clear existing headers\r\n        clearHeaders(res);\r\n        // add error headers\r\n        if (error && error.headers) {\r\n            setHeaders(res, error.headers);\r\n        }\r\n        // send basic response\r\n        res.statusCode = status;\r\n        res.setHeader(\"Content-Type\", \"text/html; charset=UTF-8\");\r\n        res.setHeader(\"Content-Length\", Buffer.byteLength(doc));\r\n        res.setHeader(\"Content-Security-Policy\", \"default-src 'none'\");\r\n        res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\r\n        res.end(doc);\r\n    };\r\n    /**\r\n     * Check if the pathname ends with \"/\".\r\n     */\r\n    SendStream.prototype.hasTrailingSlash = function () {\r\n        return this.path[this.path.length - 1] === \"/\";\r\n    };\r\n    /**\r\n     * Check if this is a conditional GET request.\r\n     * @api\r\n     */\r\n    SendStream.prototype.isConditionalGET = function () {\r\n        return !!(this.req.headers[\"if-match\"] ||\r\n            this.req.headers[\"if-unmodified-since\"] ||\r\n            this.req.headers[\"if-none-match\"] ||\r\n            this.req.headers[\"if-modified-since\"]);\r\n    };\r\n    /**\r\n     * Check if the request preconditions failed.\r\n     */\r\n    SendStream.prototype.isPreconditionFailure = function () {\r\n        var req = this.req;\r\n        var res = this.res;\r\n        // if-match\r\n        var match = req.headers[\"if-match\"];\r\n        if (match) {\r\n            var etag_1 = res.getHeader(\"ETag\");\r\n            return (!etag_1 ||\r\n                (match !== \"*\" &&\r\n                    parseTokenList(match).every(function (match) {\r\n                        return match !== etag_1 && match !== \"W/\" + etag_1 && \"W/\" + match !== etag_1;\r\n                    })));\r\n        }\r\n        // if-unmodified-since\r\n        var unmodifiedSince = parseHttpDate(req.headers[\"if-unmodified-since\"]);\r\n        if (!isNaN(unmodifiedSince)) {\r\n            var lastModified = parseHttpDate(res.getHeader(\"Last-Modified\"));\r\n            return isNaN(lastModified) || lastModified > unmodifiedSince;\r\n        }\r\n        return false;\r\n    };\r\n    /**\r\n     * Strip content-* header fields.\r\n     */\r\n    SendStream.prototype.removeContentHeaderFields = function () {\r\n        var res = this.res;\r\n        var headers = getHeaderNames(res);\r\n        for (var i = 0; i < headers.length; i++) {\r\n            var header = headers[i];\r\n            if (header.substr(0, 8) === \"content-\" && header !== \"content-location\") {\r\n                res.removeHeader(header);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * Respond with 304 not modified.\r\n     * @api\r\n     */\r\n    SendStream.prototype.notModified = function () {\r\n        var res = this.res;\r\n        debug(\"not modified\");\r\n        this.removeContentHeaderFields();\r\n        res.statusCode = 304;\r\n        res.end();\r\n    };\r\n    /**\r\n     * Raise error that headers already sent.\r\n     * @api\r\n     */\r\n    SendStream.prototype.headersAlreadySent = function () {\r\n        var err = new Error(\"Can't set headers after they are sent.\");\r\n        debug(\"headers already sent\");\r\n        this.error(500, err);\r\n    };\r\n    /**\r\n     * Check if the request is cacheable, aka responded with 2xx or 304 (see RFC 2616 section 14.2{5,6}).\r\n     * @api\r\n     */\r\n    SendStream.prototype.isCachable = function () {\r\n        var statusCode = this.res.statusCode;\r\n        return (statusCode >= 200 && statusCode < 300) || statusCode === 304;\r\n    };\r\n    /**\r\n     * Handle stat() error.\r\n     */\r\n    SendStream.prototype.onStatError = function (error) {\r\n        switch (error.code) {\r\n            case \"ENAMETOOLONG\":\r\n            case \"ENOENT\":\r\n            case \"ENOTDIR\":\r\n                this.error(404, error);\r\n                break;\r\n            default:\r\n                this.error(500, error);\r\n                break;\r\n        }\r\n    };\r\n    /**\r\n     * Check if the cache is fresh.\r\n     * @api\r\n     */\r\n    SendStream.prototype.isFresh = function () {\r\n        return fresh(this.req.headers, {\r\n            etag: this.res.getHeader(\"ETag\"),\r\n            \"last-modified\": this.res.getHeader(\"Last-Modified\"),\r\n        });\r\n    };\r\n    /**\r\n     * Check if the range is fresh.\r\n     * @api\r\n     */\r\n    SendStream.prototype.isRangeFresh = function () {\r\n        var ifRange = this.req.headers[\"if-range\"];\r\n        if (!ifRange) {\r\n            return true;\r\n        }\r\n        // if-range as etag\r\n        if (ifRange.indexOf('\"') !== -1) {\r\n            var etag_2 = this.res.getHeader(\"ETag\");\r\n            return Boolean(etag_2 && ifRange.indexOf(etag_2) !== -1);\r\n        }\r\n        // if-range as modified date\r\n        var lastModified = this.res.getHeader(\"Last-Modified\");\r\n        return parseHttpDate(lastModified) <= parseHttpDate(ifRange);\r\n    };\r\n    /**\r\n     * Redirect to path.\r\n     */\r\n    SendStream.prototype.redirect = function (path) {\r\n        var res = this.res;\r\n        if (hasListeners(this, \"directory\")) {\r\n            this.emit(\"directory\", res, path);\r\n            return;\r\n        }\r\n        if (this.hasTrailingSlash()) {\r\n            this.error(403);\r\n            return;\r\n        }\r\n        var loc = encodeUrl(collapseLeadingSlashes(this.path + \"/\"));\r\n        var doc = createHtmlDocument(\"Redirecting\", 'Redirecting to <a href=\"' + escapeHtml(loc) + '\">' + escapeHtml(loc) + \"</a>\");\r\n        // redirect\r\n        res.statusCode = 301;\r\n        res.setHeader(\"Content-Type\", \"text/html; charset=UTF-8\");\r\n        res.setHeader(\"Content-Length\", Buffer.byteLength(doc));\r\n        res.setHeader(\"Content-Security-Policy\", \"default-src 'none'\");\r\n        res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\r\n        res.setHeader(\"Location\", loc);\r\n        res.end(doc);\r\n    };\r\n    /**\r\n     * Pipe to `res`.\r\n     * @api\r\n     */\r\n    SendStream.prototype.pipe = function (res) {\r\n        // root path\r\n        var root = this._root;\r\n        // references\r\n        this.res = res;\r\n        // decode the path\r\n        var decodedPath = decode(this.path);\r\n        if (decodedPath === -1) {\r\n            this.error(400);\r\n            return res;\r\n        }\r\n        var path = decodedPath;\r\n        // null byte(s)\r\n        if (~path.indexOf(\"\\0\")) {\r\n            this.error(400);\r\n            return res;\r\n        }\r\n        var parts;\r\n        if (root !== null) {\r\n            // normalize\r\n            if (path) {\r\n                path = normalize(\".\" + sep + path);\r\n            }\r\n            // malicious path\r\n            if (UP_PATH_REGEXP.test(path)) {\r\n                debug('malicious path \"%s\"', path);\r\n                this.error(403);\r\n                return res;\r\n            }\r\n            // explode path parts\r\n            parts = path.split(sep);\r\n            // join / normalize from optional root dir\r\n            path = normalize(join(root, path));\r\n        }\r\n        else {\r\n            // \"..\" is malicious without \"root\"\r\n            if (UP_PATH_REGEXP.test(path)) {\r\n                debug('malicious path \"%s\"', path);\r\n                this.error(403);\r\n                return res;\r\n            }\r\n            // explode path parts\r\n            parts = normalize(path).split(sep);\r\n            // resolve the path\r\n            path = resolve(path);\r\n        }\r\n        // dotfile handling\r\n        if (containsDotFile(parts)) {\r\n            var access = this._dotfiles;\r\n            debug('%s dotfile \"%s\"', access, path);\r\n            switch (access) {\r\n                case \"allow\":\r\n                    break;\r\n                case \"deny\":\r\n                    this.error(403);\r\n                    return res;\r\n                case \"ignore\":\r\n                default:\r\n                    this.error(404);\r\n                    return res;\r\n            }\r\n        }\r\n        // index file support\r\n        if (this._index.length && this.hasTrailingSlash()) {\r\n            this.sendIndex(path);\r\n            return res;\r\n        }\r\n        this.sendFile(path);\r\n        return res;\r\n    };\r\n    /**\r\n     * Transfer `path`.\r\n     * @api\r\n     */\r\n    SendStream.prototype.send = function (path, stat) {\r\n        var options = this.options;\r\n        var opts = {};\r\n        var res = this.res;\r\n        var req = this.req;\r\n        var ranges = req.headers.range;\r\n        var len = stat.size;\r\n        var offset = options.start || 0;\r\n        if (headersSent(res)) {\r\n            // impossible to send now\r\n            this.headersAlreadySent();\r\n            return;\r\n        }\r\n        debug('pipe \"%s\"', path);\r\n        // set header fields\r\n        this.setHeader(path, stat);\r\n        // set content-type\r\n        this.type(path);\r\n        // conditional GET support\r\n        if (this.isConditionalGET()) {\r\n            if (this.isPreconditionFailure()) {\r\n                this.error(412);\r\n                return;\r\n            }\r\n            if (this.isCachable() && this.isFresh()) {\r\n                this.notModified();\r\n                return;\r\n            }\r\n        }\r\n        // adjust len to start/end options\r\n        len = Math.max(0, len - offset);\r\n        if (options.end !== undefined) {\r\n            var bytes = options.end - offset + 1;\r\n            if (len > bytes) {\r\n                len = bytes;\r\n            }\r\n        }\r\n        // Range support\r\n        if (this._acceptRanges && BYTES_RANGE_REGEXP.test(ranges)) {\r\n            // parse\r\n            var parsedRanges = parseRange(len, ranges, {\r\n                combine: true,\r\n            });\r\n            // If-Range support\r\n            if (!this.isRangeFresh()) {\r\n                debug(\"range stale\");\r\n                parsedRanges = -2;\r\n            }\r\n            // unsatisfiable\r\n            if (parsedRanges === -1) {\r\n                debug(\"range unsatisfiable\");\r\n                // Content-Range\r\n                res.setHeader(\"Content-Range\", contentRange(\"bytes\", len));\r\n                // 416 Requested Range Not Satisfiable\r\n                return this.error(416, {\r\n                    name: null,\r\n                    message: null,\r\n                    headers: { \"Content-Range\": res.getHeader(\"Content-Range\") },\r\n                });\r\n            }\r\n            // valid (syntactically invalid/multiple ranges are treated as a regular response)\r\n            if (parsedRanges !== -2 && parsedRanges.length === 1) {\r\n                debug(\"range %j\", parsedRanges);\r\n                // Content-Range\r\n                res.statusCode = 206;\r\n                res.setHeader(\"Content-Range\", contentRange(\"bytes\", len, parsedRanges[0]));\r\n                // adjust for requested range\r\n                offset += parsedRanges[0].start;\r\n                len = parsedRanges[0].end - parsedRanges[0].start + 1;\r\n            }\r\n        }\r\n        // clone options\r\n        for (var prop in options) {\r\n            opts[prop] = options[prop];\r\n        }\r\n        // set read options\r\n        opts.start = offset;\r\n        opts.end = Math.max(offset, offset + len - 1);\r\n        // content-length\r\n        res.setHeader(\"Content-Length\", len);\r\n        // HEAD support\r\n        if (req.method === \"HEAD\") {\r\n            res.end();\r\n            return;\r\n        }\r\n        this.stream(path, opts);\r\n    };\r\n    /**\r\n     * Transfer file for `path`.\r\n     * @api\r\n     */\r\n    SendStream.prototype.sendFile = function (path) {\r\n        var self = this;\r\n        var i = 0;\r\n        debug('stat \"%s\"', path);\r\n        fs.stat(path, function onstat(err, stat) {\r\n            if (err && err.code === \"ENOENT\" && !extname(path) && path[path.length - 1] !== sep) {\r\n                // not found, check extensions\r\n                return next(err);\r\n            }\r\n            if (err)\r\n                return self.onStatError(err);\r\n            if (stat.isDirectory())\r\n                return self.redirect(path);\r\n            self.emit(\"file\", path, stat);\r\n            self.send(path, stat);\r\n        });\r\n        function next(err) {\r\n            if (self._extensions.length <= i) {\r\n                return err ? self.onStatError(err) : self.error(404);\r\n            }\r\n            var p = path + \".\" + self._extensions[i++];\r\n            debug('stat \"%s\"', p);\r\n            fs.stat(p, function (err, stat) {\r\n                if (err) {\r\n                    return next(err);\r\n                }\r\n                if (stat.isDirectory()) {\r\n                    return next();\r\n                }\r\n                self.emit(\"file\", p, stat);\r\n                self.send(p, stat);\r\n            });\r\n        }\r\n    };\r\n    /**\r\n     * Transfer index for `path`.\r\n     * @api\r\n     */\r\n    SendStream.prototype.sendIndex = function (path) {\r\n        var self = this;\r\n        var i = -1;\r\n        function next(err) {\r\n            if (++i >= self._index.length) {\r\n                if (err) {\r\n                    return self.onStatError(err);\r\n                }\r\n                return self.error(404);\r\n            }\r\n            var p = join(path, self._index[i]);\r\n            debug('stat \"%s\"', p);\r\n            fs.stat(p, function (err, stat) {\r\n                if (err) {\r\n                    return next(err);\r\n                }\r\n                if (stat.isDirectory()) {\r\n                    return next();\r\n                }\r\n                self.emit(\"file\", p, stat);\r\n                self.send(p, stat);\r\n            });\r\n        }\r\n        next();\r\n    };\r\n    /**\r\n     * Transfer index for `path`.\r\n     * @api\r\n     */\r\n    SendStream.prototype.stream = function (path, options) {\r\n        // TODO: this is all lame, refactor meeee\r\n        var self = this;\r\n        var res = this.res;\r\n        var finished = false;\r\n        // pipe\r\n        var stream = fs.createReadStream(path, options);\r\n        this.emit(\"stream\", stream);\r\n        stream.pipe(res);\r\n        // response finished, done with the fd\r\n        onFinished(res, function onfinished() {\r\n            finished = true;\r\n            destroy(stream);\r\n        });\r\n        // error handling code-smell\r\n        stream.on(\"error\", function onerror(err) {\r\n            // request already finished\r\n            if (finished)\r\n                return;\r\n            // clean up stream\r\n            finished = true;\r\n            destroy(stream);\r\n            // error\r\n            self.onStatError(err);\r\n        });\r\n        // end\r\n        stream.on(\"end\", function onend() {\r\n            self.emit(\"end\");\r\n        });\r\n    };\r\n    /**\r\n     * Set content-type based on `path` if it hasn't been explicitly set.\r\n     * @api\r\n     */\r\n    SendStream.prototype.type = function (path) {\r\n        var res = this.res;\r\n        if (res.getHeader(\"Content-Type\")) {\r\n            return;\r\n        }\r\n        var type = mime.lookup(path);\r\n        if (!type) {\r\n            debug(\"no content-type\");\r\n            return;\r\n        }\r\n        var charset = mime.charset(type);\r\n        debug(\"content-type %s\", type);\r\n        res.setHeader(\"Content-Type\", type + (charset ? \"; charset=\" + charset : \"\"));\r\n    };\r\n    /**\r\n     * Set response header fields, most fields may be pre-defined.\r\n     * @api\r\n     */\r\n    SendStream.prototype.setHeader = function (path, stat) {\r\n        var res = this.res;\r\n        this.emit(\"headers\", res, path, stat);\r\n        if (this._acceptRanges && !res.getHeader(\"Accept-Ranges\")) {\r\n            debug(\"accept ranges\");\r\n            res.setHeader(\"Accept-Ranges\", \"bytes\");\r\n        }\r\n        if (this._cacheControl && !res.getHeader(\"Cache-Control\")) {\r\n            var cacheControl = \"public, max-age=\" + Math.floor(this._maxAge / 1000);\r\n            if (this._immutable) {\r\n                cacheControl += \", immutable\";\r\n            }\r\n            debug(\"cache-control %s\", cacheControl);\r\n            res.setHeader(\"Cache-Control\", cacheControl);\r\n        }\r\n        if (this._lastModified && !res.getHeader(\"Last-Modified\")) {\r\n            var modified = stat.mtime.toUTCString();\r\n            debug(\"modified %s\", modified);\r\n            res.setHeader(\"Last-Modified\", modified);\r\n        }\r\n        if (this._etag && !res.getHeader(\"ETag\")) {\r\n            var val = etag(stat);\r\n            debug(\"etag %s\", val);\r\n            res.setHeader(\"ETag\", val);\r\n        }\r\n    };\r\n    return SendStream;\r\n}(Stream));\r\nexport { SendStream };\r\n/**\r\n * Regular expression for identifying a bytes Range header.\r\n * @private\r\n */\r\nvar BYTES_RANGE_REGEXP = /^ *bytes=/;\r\n/**\r\n * Maximum value allowed for the max age.\r\n * @private\r\n */\r\nvar MAX_MAXAGE = 60 * 60 * 24 * 365 * 1000; // 1 year\r\n/**\r\n * Regular expression to match a path with a directory up component.\r\n * @private\r\n */\r\nvar UP_PATH_REGEXP = /(?:^|[\\\\/])\\.\\.(?:[\\\\/]|$)/;\r\n/**\r\n * Clear all headers from a response.\r\n * @private\r\n */\r\nfunction clearHeaders(res) {\r\n    var headers = getHeaderNames(res);\r\n    for (var i = 0; i < headers.length; i++) {\r\n        res.removeHeader(headers[i]);\r\n    }\r\n}\r\n/**\r\n * Collapse all leading slashes into a single slash\r\n * @private\r\n */\r\nfunction collapseLeadingSlashes(str) {\r\n    var i;\r\n    for (i = 0; i < str.length; i++) {\r\n        if (str[i] !== \"/\") {\r\n            break;\r\n        }\r\n    }\r\n    return i > 1 ? \"/\" + str.substr(i) : str;\r\n}\r\n/**\r\n * Determine if path parts contain a dotfile.\r\n *\r\n * @api private\r\n */\r\nfunction containsDotFile(parts) {\r\n    for (var i = 0; i < parts.length; i++) {\r\n        var part = parts[i];\r\n        if (part.length > 1 && part[0] === \".\") {\r\n            return true;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n/**\r\n * Create a Content-Range header.\r\n *\r\n * @param {string} type\r\n * @param {number} size\r\n * @param {array} [range]\r\n */\r\nfunction contentRange(type, size, range) {\r\n    return type + \" \" + (range ? range.start + \"-\" + range.end : \"*\") + \"/\" + size;\r\n}\r\n/**\r\n * Create a minimal HTML document.\r\n *\r\n * @param {string} title\r\n * @param {string} body\r\n * @private\r\n */\r\nfunction createHtmlDocument(title, body) {\r\n    return (\"<!DOCTYPE html>\\n\" +\r\n        '<html lang=\"en\">\\n' +\r\n        \"<head>\\n\" +\r\n        '<meta charset=\"utf-8\">\\n' +\r\n        \"<title>\" +\r\n        title +\r\n        \"</title>\\n\" +\r\n        \"</head>\\n\" +\r\n        \"<body>\\n\" +\r\n        \"<pre>\" +\r\n        body +\r\n        \"</pre>\\n\" +\r\n        \"</body>\\n\" +\r\n        \"</html>\\n\");\r\n}\r\n/**\r\n * decodeURIComponent.\r\n *\r\n * Allows V8 to only deoptimize this fn instead of all\r\n * of send().\r\n *\r\n * @param {String} path\r\n * @api private\r\n */\r\nfunction decode(path) {\r\n    try {\r\n        return decodeURIComponent(path);\r\n    }\r\n    catch (err) {\r\n        return -1;\r\n    }\r\n}\r\n/**\r\n * Get the header names on a respnse.\r\n * @private\r\n */\r\nfunction getHeaderNames(res) {\r\n    return typeof res.getHeaderNames !== \"function\" ? [] : res.getHeaderNames();\r\n}\r\n/**\r\n * Determine if emitter has listeners of a given type.\r\n *\r\n * The way to do this check is done three different ways in Node.js >= 0.8\r\n * so this consolidates them into a minimal set using instance methods.\r\n * @private\r\n */\r\nfunction hasListeners(emitter, type) {\r\n    var count = typeof emitter.listenerCount !== \"function\" ? emitter.listeners(type).length : emitter.listenerCount(type);\r\n    return count > 0;\r\n}\r\n/**\r\n * Determine if the response headers have been sent.\r\n * @private\r\n */\r\nfunction headersSent(res) {\r\n    return res.headersSent;\r\n}\r\n/**\r\n * Normalize the index option into an array.\r\n * @private\r\n */\r\nfunction normalizeList(val, name) {\r\n    var list = [].concat(val || []);\r\n    for (var i = 0; i < list.length; i++) {\r\n        if (typeof list[i] !== \"string\") {\r\n            throw new TypeError(name + \" must be array of strings or false\");\r\n        }\r\n    }\r\n    return list;\r\n}\r\n/**\r\n * Parse an HTTP Date into a number.\r\n * @private\r\n */\r\nfunction parseHttpDate(date) {\r\n    var timestamp = date && Date.parse(date);\r\n    return typeof timestamp === \"number\" ? timestamp : NaN;\r\n}\r\n/**\r\n * Parse a HTTP token list.\r\n * @private\r\n */\r\nfunction parseTokenList(str) {\r\n    var start = 0;\r\n    var end = 0;\r\n    var list = [];\r\n    // gather tokens\r\n    for (var i = 0, len = str.length; i < len; i++) {\r\n        switch (str.charCodeAt(i)) {\r\n            case 0x20 /*   */:\r\n                if (start === end) {\r\n                    start = end = i + 1;\r\n                }\r\n                break;\r\n            case 0x2c /* , */:\r\n                list.push(str.substring(start, end));\r\n                start = end = i + 1;\r\n                break;\r\n            default:\r\n                end = i + 1;\r\n                break;\r\n        }\r\n    }\r\n    // final token\r\n    list.push(str.substring(start, end));\r\n    return list;\r\n}\r\n/**\r\n * Set an object of headers on a response.\r\n * @private\r\n */\r\nfunction setHeaders(res, headers) {\r\n    var keys = Object.keys(headers);\r\n    for (var i = 0; i < keys.length; i++) {\r\n        var key = keys[i];\r\n        res.setHeader(key, headers[key]);\r\n    }\r\n}\r\n/**\r\n * Return a `SendStream` for `req` and `path`.\r\n * @public\r\n */\r\nexport default function send(req, path, options) {\r\n    return new SendStream(req, path, options);\r\n}\r\nexport { mime };\r\n//# sourceMappingURL=send.js.map"]}