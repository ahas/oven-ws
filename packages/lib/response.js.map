{"version":3,"sources":["response.js"],"names":["Buffer","contentDisposition","encodeUrl","escapeHtml","http","onFinished","extname","resolve","statuses","merge","sign","isAbsolute","normalizeType","normalizeTypes","setCharset","cookie","send","mime","vary","res","Object","create","ServerResponse","prototype","charsetRegExp","status","statusCode","links","link","get","set","keys","map","rel","join","body","req","chunk","encoding","type","app","isBuffer","app_1","escape_1","$","replacer","spaces","body_1","stringify","etagFn","generateETag","len","undefined","length","byteLength","from","etag","fresh","removeHeader","method","end","sendFile","path","options","callback","next","done","opts","TypeError","root","pathname","encodeURI","file","pipeFile","err","code","syscall","download","filename","name","headers","i","key","toLowerCase","fullPath","contentType","ct","indexOf","lookup","format","obj","fn","default","accepts","value","Error","types","o","attachment","append","field","val","prev","Array","isArray","concat","getHeader","header","arguments","String","test","charset","split","setHeader","clearCookie","expires","Date","secret","signed","JSON","now","maxAge","serialize","location","url","loc","redirect","address","text","message","html","u","render","view","self","_locals","locals","str","isDone","isStreaming","onaborted","ondirectory","onerror","onend","onfile","onfinish","setImmediate","onstream","on","k","pipe","space","escape","json","replace","c","charCodeAt"],"mappings":"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","file":"response.js","sourcesContent":["import { Buffer } from \"safe-buffer\";\r\nimport contentDisposition from \"content-disposition\";\r\nimport encodeUrl from \"encodeurl\";\r\nimport escapeHtml from \"escape-html\";\r\nimport http from \"http\";\r\nimport onFinished from \"on-finished\";\r\nimport { extname, resolve } from \"path\";\r\nimport statuses from \"statuses\";\r\nimport merge from \"utils-merge\";\r\nimport { sign } from \"cookie-signature\";\r\nimport { isAbsolute, normalizeType, normalizeTypes, setCharset } from \"./utils\";\r\nimport cookie from \"cookie\";\r\nimport send, { mime } from \"./send\";\r\nimport vary from \"vary\";\r\n/**\r\n * Response prototype.\r\n * @public\r\n */\r\nvar res = Object.create(http.ServerResponse.prototype);\r\n/**\r\n * Module exports.\r\n * @public\r\n */\r\nexport default res;\r\n/**\r\n * Module variables.\r\n * @private\r\n */\r\nvar charsetRegExp = /;\\s*charset\\s*=/;\r\n/**\r\n * Set status `code`.\r\n *\r\n * @param {Number} statusCode\r\n * @return {ServerResponse}\r\n * @public\r\n */\r\nres.status = function status(statusCode) {\r\n    this.statusCode = statusCode;\r\n    return this;\r\n};\r\n/**\r\n * Set Link header field with the given `links`.\r\n *\r\n * Examples:\r\n *\r\n *    res.links({\r\n *      next: 'http://api.example.com/users?page=2',\r\n *      last: 'http://api.example.com/users?page=5'\r\n *    });\r\n *\r\n * @param {Object} links\r\n * @return {ServerResponse}\r\n * @public\r\n */\r\nres.links = function (links) {\r\n    var link = this.get(\"Link\") || \"\";\r\n    if (link) {\r\n        link += \", \";\r\n    }\r\n    return this.set(\"Link\", link +\r\n        Object.keys(links)\r\n            .map(function (rel) {\r\n            return \"<\" + links[rel] + '>; rel=\"' + rel + '\"';\r\n        })\r\n            .join(\", \"));\r\n};\r\n/**\r\n * Send a response.\r\n *\r\n * Examples:\r\n *\r\n *     res.send(Buffer.from('wahoo'));\r\n *     res.send({ some: 'json' });\r\n *     res.send('<p>some html</p>');\r\n *\r\n * @param {string|number|boolean|object|Buffer} body\r\n * @public\r\n */\r\nres.send = function send(body) {\r\n    var req = this.req;\r\n    var chunk = body;\r\n    var encoding;\r\n    var type;\r\n    // settings\r\n    var app = this.app;\r\n    switch (typeof chunk) {\r\n        // string defaulting to html\r\n        case \"string\":\r\n            if (!this.get(\"Content-Type\")) {\r\n                this.type(\"html\");\r\n            }\r\n            break;\r\n        case \"boolean\":\r\n        case \"number\":\r\n        case \"object\":\r\n            if (chunk === null) {\r\n                chunk = \"\";\r\n            }\r\n            else if (Buffer.isBuffer(chunk)) {\r\n                if (!this.get(\"Content-Type\")) {\r\n                    this.type(\"bin\");\r\n                }\r\n            }\r\n            else {\r\n                // settings\r\n                var app_1 = this.app;\r\n                var escape_1 = app_1.$(\"json escape\");\r\n                var replacer = app_1.$(\"json replacer\");\r\n                var spaces = app_1.$(\"json spaces\");\r\n                var body_1 = stringify(chunk, replacer, spaces, escape_1);\r\n                // content-type\r\n                if (!this.get(\"Content-Type\")) {\r\n                    this.set(\"Content-Type\", \"application/json\");\r\n                }\r\n                return this.send(body_1);\r\n            }\r\n            break;\r\n    }\r\n    // write strings in utf-8\r\n    if (typeof chunk === \"string\") {\r\n        encoding = \"utf8\";\r\n        type = this.get(\"Content-Type\");\r\n        // reflect this in content-type\r\n        if (typeof type === \"string\") {\r\n            this.set(\"Content-Type\", setCharset(type, \"utf-8\"));\r\n        }\r\n    }\r\n    // determine if ETag should be generated\r\n    var etagFn = app.$(\"etag fn\");\r\n    var generateETag = !this.get(\"ETag\") && typeof etagFn === \"function\";\r\n    // populate Content-Length\r\n    var len;\r\n    if (chunk !== undefined) {\r\n        if (Buffer.isBuffer(chunk)) {\r\n            // get length of Buffer\r\n            len = chunk.length;\r\n        }\r\n        else if (!generateETag && chunk.length < 1000) {\r\n            // just calculate length when no ETag + small chunk\r\n            len = Buffer.byteLength(chunk, encoding);\r\n        }\r\n        else {\r\n            // convert chunk to Buffer and calculate\r\n            chunk = Buffer.from(chunk, encoding);\r\n            encoding = undefined;\r\n            len = chunk.length;\r\n        }\r\n        this.set(\"Content-Length\", len);\r\n    }\r\n    // populate ETag\r\n    var etag;\r\n    if (generateETag && len !== undefined) {\r\n        if ((etag = etagFn(chunk, encoding))) {\r\n            this.set(\"ETag\", etag);\r\n        }\r\n    }\r\n    // freshness\r\n    if (req.fresh) {\r\n        this.statusCode = 304;\r\n    }\r\n    // strip irrelevant headers\r\n    if (204 === this.statusCode || 304 === this.statusCode) {\r\n        this.removeHeader(\"Content-Type\");\r\n        this.removeHeader(\"Content-Length\");\r\n        this.removeHeader(\"Transfer-Encoding\");\r\n        chunk = \"\";\r\n    }\r\n    if (req.method === \"HEAD\") {\r\n        // skip body for HEAD\r\n        this.end();\r\n    }\r\n    else {\r\n        // respond\r\n        this.end(chunk, encoding);\r\n    }\r\n    return this;\r\n};\r\n/**\r\n * Transfer the file at the given `path`.\r\n *\r\n * Automatically sets the _Content-Type_ response header field.\r\n * The callback `callback(err)` is invoked when the transfer is complete\r\n * or when an error occurs. Be sure to check `res.sentHeader`\r\n * if you wish to attempt responding, as the header and some data\r\n * may have already been transferred.\r\n *\r\n * Options:\r\n *\r\n *   - `maxAge`   defaulting to 0 (can be string converted by `ms`)\r\n *   - `root`     root directory for relative filenames\r\n *   - `headers`  object of headers to serve with file\r\n *   - `dotfiles` serve dotfiles, defaulting to false; can be `\"allow\"` to send them\r\n *\r\n * Other options are passed along to `send`.\r\n *\r\n * Examples:\r\n *\r\n *  The following example illustrates how `res.sendFile()` may\r\n *  be used as an alternative for the `static()` middleware for\r\n *  dynamic situations. The code backing `res.sendFile()` is actually\r\n *  the same code, so HTTP cache support etc is identical.\r\n *\r\n *     app.get('/user/:uid/photos/:file', function(req, res){\r\n *       let uid = req.params.uid\r\n *         , file = req.params.file;\r\n *\r\n *       req.user.mayViewFilesFrom(uid, function(yes){\r\n *         if (yes) {\r\n *           res.sendFile('/uploads/' + uid + '/' + file);\r\n *         } else {\r\n *           res.send(403, 'Sorry! you cant see that.');\r\n *         }\r\n *       });\r\n *     });\r\n *\r\n * @public\r\n */\r\nres.sendFile = function sendFile(path, options, callback) {\r\n    var req = this.req;\r\n    var next = req.next;\r\n    var done = callback;\r\n    var opts = options || {};\r\n    if (!path) {\r\n        throw new TypeError(\"path argument is required to res.sendFile\");\r\n    }\r\n    if (typeof path !== \"string\") {\r\n        throw new TypeError(\"path must be a string to res.sendFile\");\r\n    }\r\n    // support function as second arg\r\n    if (typeof options === \"function\") {\r\n        done = options;\r\n        opts = {};\r\n    }\r\n    if (!opts.root && !isAbsolute(path)) {\r\n        throw new TypeError(\"path must be absolute or specify root to res.sendFile\");\r\n    }\r\n    // create file stream\r\n    var pathname = encodeURI(path);\r\n    var file = send(req, pathname, opts);\r\n    // transfer\r\n    pipeFile(this, file, opts, function (err) {\r\n        if (done) {\r\n            return done(err);\r\n        }\r\n        else if (err) {\r\n            if (err.code === \"EISDIR\") {\r\n                next();\r\n            }\r\n            else if (err.code !== \"ECONNABORTED\" && err.syscall !== \"write\") {\r\n                next(err);\r\n            }\r\n        }\r\n    });\r\n};\r\n/**\r\n * Transfer the file at the given `path` as an attachment.\r\n *\r\n * Optionally providing an alternate attachment `filename`,\r\n * and optional callback `callback(err)`. The callback is invoked\r\n * when the data transfer is complete, or when an error has\r\n * ocurred. Be sure to check `res.headersSent` if you plan to respond.\r\n *\r\n * Optionally providing an `options` object to use with `res.sendFile()`.\r\n * This function will set the `Content-Disposition` header, overriding\r\n * any `Content-Disposition` header passed as header options in order\r\n * to set the attachment and filename.\r\n *\r\n * This method uses `res.sendFile()`.\r\n *\r\n * @public\r\n */\r\nres.download = function download(path, filename, options, callback) {\r\n    var name = filename;\r\n    var done = callback;\r\n    var opts = options || null;\r\n    // support function as second or third arg\r\n    if (typeof filename === \"function\") {\r\n        done = filename;\r\n        name = null;\r\n        opts = null;\r\n    }\r\n    else if (typeof options === \"function\") {\r\n        done = options;\r\n        opts = null;\r\n    }\r\n    // set Content-Disposition when file is sent\r\n    var headers = {\r\n        \"Content-Disposition\": contentDisposition((name || path)),\r\n    };\r\n    // merge user-provided headers\r\n    if (opts && opts.headers) {\r\n        var keys = Object.keys(opts.headers);\r\n        for (var i = 0; i < keys.length; i++) {\r\n            var key = keys[i];\r\n            if (key.toLowerCase() !== \"content-disposition\") {\r\n                headers[key] = opts.headers[key];\r\n            }\r\n        }\r\n    }\r\n    // merge user-provided options\r\n    opts = Object.create(opts);\r\n    opts.headers = headers;\r\n    // Resolve the full path for sendFile\r\n    var fullPath = resolve(path);\r\n    // send file\r\n    return this.sendFile(fullPath, opts, done);\r\n};\r\n/**\r\n * Set _Content-Type_ response header with `type` through `mime.lookup()`\r\n * when it does not contain \"/\", or set the Content-Type to `type` otherwise.\r\n *\r\n * Examples:\r\n *\r\n *     res.type('.html');\r\n *     res.type('html');\r\n *     res.type('json');\r\n *     res.type('application/json');\r\n *     res.type('png');\r\n *\r\n * @param {String} type\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.type = function contentType(type) {\r\n    var ct = type.indexOf(\"/\") === -1 ? mime.lookup(type) : type;\r\n    return this.set(\"Content-Type\", ct);\r\n};\r\n/**\r\n * Respond to the Acceptable formats using an `obj`\r\n * of mime-type callbacks.\r\n *\r\n * This method uses `req.accepted`, an array of\r\n * acceptable types ordered by their quality values.\r\n * When \"Accept\" is not present the _first_ callback\r\n * is invoked, otherwise the first match is used. When\r\n * no match is performed the server responds with\r\n * 406 \"Not Acceptable\".\r\n *\r\n * Content-Type is set for you, however if you choose\r\n * you may alter this within the callback using `res.type()`\r\n * or `res.set('Content-Type', ...)`.\r\n *\r\n *    res.format({\r\n *      'text/plain': function(){\r\n *        res.send('hey');\r\n *      },\r\n *\r\n *      'text/html': function(){\r\n *        res.send('<p>hey</p>');\r\n *      },\r\n *\r\n *      'appliation/json': function(){\r\n *        res.send({ message: 'hey' });\r\n *      }\r\n *    });\r\n *\r\n * In addition to canonicalized MIME types you may\r\n * also use extnames mapped to these types:\r\n *\r\n *    res.format({\r\n *      text: function(){\r\n *        res.send('hey');\r\n *      },\r\n *\r\n *      html: function(){\r\n *        res.send('<p>hey</p>');\r\n *      },\r\n *\r\n *      json: function(){\r\n *        res.send({ message: 'hey' });\r\n *      }\r\n *    });\r\n *\r\n * By default WS passes an `Error`\r\n * with a `.status` of 406 to `next(err)`\r\n * if a match is not made. If you provide\r\n * a `.default` callback it will be invoked\r\n * instead.\r\n *\r\n * @param {Object} obj\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.format = function (obj) {\r\n    var req = this.req;\r\n    var next = req.next;\r\n    var fn = obj.default;\r\n    if (fn) {\r\n        delete obj.default;\r\n    }\r\n    var keys = Object.keys(obj);\r\n    var key = keys.length > 0 ? req.accepts(keys) : false;\r\n    this.vary(\"Accept\");\r\n    if (key) {\r\n        this.set(\"Content-Type\", normalizeType(key).value);\r\n        obj[key](req, this, next);\r\n    }\r\n    else if (fn) {\r\n        fn();\r\n    }\r\n    else {\r\n        var err = new Error(\"Not Acceptable\");\r\n        err.status = err.status = 406;\r\n        err.types = normalizeTypes(keys).map(function (o) {\r\n            return o.value;\r\n        });\r\n        next(err);\r\n    }\r\n    return this;\r\n};\r\n/**\r\n * Set _Content-Disposition_ header to _attachment_ with optional `filename`.\r\n *\r\n * @param {String} filename\r\n * @return {ServerResponse}\r\n * @public\r\n */\r\nres.attachment = function attachment(filename) {\r\n    if (filename) {\r\n        this.type(extname(filename));\r\n    }\r\n    this.set(\"Content-Disposition\", contentDisposition(filename));\r\n    return this;\r\n};\r\n/**\r\n * Append additional header `field` with value `val`.\r\n *\r\n * Example:\r\n *\r\n *    res.append('Link', ['<http://localhost/>', '<http://localhost:3000/>']);\r\n *    res.append('Set-Cookie', 'foo=bar; Path=/; HttpOnly');\r\n *    res.append('Warning', '199 Miscellaneous warning');\r\n *\r\n * @param {String} field\r\n * @param {String|Array} val\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.append = function append(field, val) {\r\n    var prev = this.get(field);\r\n    var value = val;\r\n    if (prev) {\r\n        // concat the new and prev vals\r\n        value = Array.isArray(prev) ? prev.concat(val) : Array.isArray(val) ? [prev].concat(val) : [prev, val];\r\n    }\r\n    return this.set(field, value);\r\n};\r\n/**\r\n * Get value for header `field`.\r\n *\r\n * @param {String} field\r\n * @return {String}\r\n * @public\r\n */\r\nres.get = function (field) {\r\n    return this.getHeader(field);\r\n};\r\n/**\r\n * Set header `field` to `val`, or pass\r\n * an object of header fields.\r\n *\r\n * Examples:\r\n *\r\n *    res.set('Foo', ['bar', 'baz']);\r\n *    res.set('Accept', 'application/json');\r\n *    res.set({ Accept: 'text/plain', 'X-API-Key': 'tobi' });\r\n *\r\n * Aliased as `res.header()`.\r\n *\r\n * @param {String|Object} field\r\n * @param {String|Array} val\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.set = function header(field, val) {\r\n    if (arguments.length === 2) {\r\n        var value = Array.isArray(val) ? val.map(String) : String(val);\r\n        // add charset to content-type\r\n        if (field.toLowerCase() === \"content-type\") {\r\n            if (Array.isArray(value)) {\r\n                throw new TypeError(\"Content-Type cannot be set to an Array\");\r\n            }\r\n            if (!charsetRegExp.test(value)) {\r\n                var charset = mime.charset(value.split(\";\")[0]);\r\n                if (charset) {\r\n                    value += \"; charset=\" + charset.toLowerCase();\r\n                }\r\n            }\r\n        }\r\n        this.setHeader(field, value);\r\n    }\r\n    else {\r\n        for (var key in field) {\r\n            this.set(key, field[key]);\r\n        }\r\n    }\r\n    return this;\r\n};\r\n/**\r\n * Clear cookie `name`.\r\n *\r\n * @param {String} name\r\n * @param {Object} [options]\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.clearCookie = function clearCookie(name, options) {\r\n    var opts = merge({ expires: new Date(1), path: \"/\" }, options);\r\n    return this.cookie(name, \"\", opts);\r\n};\r\n/**\r\n * Set cookie `name` to `value`, with the given `options`.\r\n *\r\n * Options:\r\n *\r\n *    - `maxAge`   max-age in milliseconds, converted to `expires`\r\n *    - `signed`   sign the cookie\r\n *    - `path`     defaults to \"/\"\r\n *\r\n * Examples:\r\n *\r\n *    // \"Remember Me\" for 15 minutes\r\n *    res.cookie('rememberme', '1', { expires: new Date(Date.now() + 900000), httpOnly: true });\r\n *\r\n *    // same as above\r\n *    res.cookie('rememberme', '1', { maxAge: 900000, httpOnly: true })\r\n *\r\n * @param {String} name\r\n * @param {String|Object} value\r\n * @param {Object} [options]\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.cookie = function (name, value, options) {\r\n    var opts = merge({}, options);\r\n    var secret = this.req.secret;\r\n    var signed = opts.signed;\r\n    if (signed && !secret) {\r\n        throw new Error('cookieParser(\"secret\") required for signed cookies');\r\n    }\r\n    var val = typeof value === \"object\" ? \"j:\" + JSON.stringify(value) : String(value);\r\n    if (signed) {\r\n        val = \"s:\" + sign(val, secret);\r\n    }\r\n    if (\"maxAge\" in opts) {\r\n        opts.expires = new Date(Date.now() + opts.maxAge);\r\n        opts.maxAge /= 1000;\r\n    }\r\n    if (opts.path == null) {\r\n        opts.path = \"/\";\r\n    }\r\n    this.append(\"Set-Cookie\", cookie.serialize(name, String(val), opts));\r\n    return this;\r\n};\r\n/**\r\n * Set the location header to `url`.\r\n *\r\n * The given `url` can also be \"back\", which redirects\r\n * to the _Referrer_ or _Referer_ headers or \"/\".\r\n *\r\n * Examples:\r\n *\r\n *    res.location('/foo/bar').;\r\n *    res.location('http://example.com');\r\n *    res.location('../login');\r\n *\r\n * @param {String} url\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.location = function location(url) {\r\n    var loc = url;\r\n    // \"back\" is an alias for the referrer\r\n    if (url === \"back\") {\r\n        loc = this.req.get(\"Referrer\") || \"/\";\r\n    }\r\n    // set location\r\n    return this.set(\"Location\", encodeUrl(loc));\r\n};\r\n/**\r\n * Redirect to the given `url` with optional response `status`\r\n * defaulting to 302.\r\n *\r\n * The resulting `url` is determined by `res.location()`, so\r\n * it will play nicely with mounted apps, relative paths,\r\n * `\"back\"` etc.\r\n *\r\n * Examples:\r\n *\r\n *    res.redirect('/foo/bar');\r\n *    res.redirect('http://example.com');\r\n *    res.redirect(301, 'http://example.com');\r\n *    res.redirect('../login'); // /blog/post/1 -> /blog/login\r\n *\r\n * @public\r\n */\r\nres.redirect = function redirect(url) {\r\n    var status = 302;\r\n    var address = url;\r\n    var body;\r\n    // Set location header\r\n    address = this.location(address).get(\"Location\");\r\n    // Support text/{plain,html} by default\r\n    this.format({\r\n        text: function () {\r\n            body = statuses.message[status] + \". Redirecting to \" + address;\r\n        },\r\n        html: function () {\r\n            var u = escapeHtml(address);\r\n            body = \"<p>\" + statuses.message[status] + '. Redirecting to <a href=\"' + u + '\">' + u + \"</a></p>\";\r\n        },\r\n        default: function () {\r\n            body = \"\";\r\n        },\r\n    });\r\n    // Respond\r\n    this.statusCode = status;\r\n    this.set(\"Content-Length\", Buffer.byteLength(body));\r\n    if (this.req.method === \"HEAD\") {\r\n        this.end();\r\n    }\r\n    else {\r\n        this.end(body);\r\n    }\r\n};\r\n/**\r\n * Add `field` to Vary. If already present in the Vary set, then\r\n * this call is simply ignored.\r\n *\r\n * @param {Array|String} field\r\n * @return {ServerResponse} for chaining\r\n * @public\r\n */\r\nres.vary = function (field) {\r\n    // checks for back-compat\r\n    if (!field || (Array.isArray(field) && !field.length)) {\r\n        throw new Error(\"res.vary(): Provide a field name\");\r\n    }\r\n    vary(this, field);\r\n    return this;\r\n};\r\n/**\r\n * Render `view` with the given `options` and optional callback `fn`.\r\n * When a callback function is given a response will _not_ be made\r\n * automatically, otherwise a response of _200_ and _text/html_ is given.\r\n *\r\n * Options:\r\n *\r\n *  - `cache`     boolean hinting to the engine it should cache\r\n *  - `filename`  filename of the view being rendered\r\n *\r\n * @public\r\n */\r\nres.render = function render(view, options, callback) {\r\n    var app = this.req.app;\r\n    var req = this.req;\r\n    var self = this;\r\n    var done = callback;\r\n    var opts = options || {};\r\n    // support callback function as second arg\r\n    if (typeof options === \"function\") {\r\n        done = options;\r\n        opts = {};\r\n    }\r\n    // merge res.locals\r\n    opts._locals = self.locals;\r\n    // default callback to respond\r\n    done =\r\n        done ||\r\n            function (err, str) {\r\n                if (err)\r\n                    return req.next(err);\r\n                self.send(str);\r\n            };\r\n    // render\r\n    app.render(view, opts, done);\r\n};\r\n// pipe the send file stream\r\nfunction pipeFile(res, file, options, callback) {\r\n    var isDone = false;\r\n    var isStreaming = false;\r\n    // request aborted\r\n    function onaborted() {\r\n        if (isDone) {\r\n            return;\r\n        }\r\n        isDone = true;\r\n        var err = new Error(\"Request aborted\");\r\n        err.code = \"ECONNABORTED\";\r\n        callback(err);\r\n    }\r\n    // directory\r\n    function ondirectory() {\r\n        if (isDone) {\r\n            return;\r\n        }\r\n        isDone = true;\r\n        var err = new Error(\"EISDIR, read\");\r\n        err.code = \"EISDIR\";\r\n        callback(err);\r\n    }\r\n    // errors\r\n    function onerror(err) {\r\n        if (isDone) {\r\n            return;\r\n        }\r\n        isDone = true;\r\n        callback(err);\r\n    }\r\n    // ended\r\n    function onend() {\r\n        if (isDone) {\r\n            return;\r\n        }\r\n        isDone = true;\r\n        callback();\r\n    }\r\n    // file\r\n    function onfile() {\r\n        isStreaming = false;\r\n    }\r\n    // finished\r\n    function onfinish(err) {\r\n        if (err && err.code === \"ECONNRESET\")\r\n            return onaborted();\r\n        if (err)\r\n            return onerror(err);\r\n        if (isDone)\r\n            return;\r\n        setImmediate(function () {\r\n            if (isStreaming !== false && !isDone) {\r\n                onaborted();\r\n                return;\r\n            }\r\n            if (isDone)\r\n                return;\r\n            isDone = true;\r\n            callback();\r\n        });\r\n    }\r\n    // streaming\r\n    function onstream() {\r\n        isStreaming = true;\r\n    }\r\n    file.on(\"directory\", ondirectory);\r\n    file.on(\"end\", onend);\r\n    file.on(\"error\", onerror);\r\n    file.on(\"file\", onfile);\r\n    file.on(\"stream\", onstream);\r\n    onFinished(res, onfinish);\r\n    if (options.headers) {\r\n        // set headers on successful transfer\r\n        file.on(\"headers\", function headers(res) {\r\n            var obj = options.headers;\r\n            var keys = Object.keys(obj);\r\n            for (var i = 0; i < keys.length; i++) {\r\n                var k = keys[i];\r\n                res.setHeader(k, obj[k]);\r\n            }\r\n        });\r\n    }\r\n    // pipe\r\n    file.pipe(res);\r\n}\r\n/**\r\n * Stringify JSON, like JSON.stringify, but v8 optimized, with the\r\n * ability to escape characters that can trigger HTML sniffing.\r\n *\r\n * @param {*} value\r\n * @param {function} replaces\r\n * @param {number} spaces\r\n * @param {boolean} escape\r\n * @returns {string}\r\n * @private\r\n */\r\nfunction stringify(value, replacer, space, escape) {\r\n    // v8 checks arguments.length for optimizing simple call\r\n    // https://bugs.chromium.org/p/v8/issues/detail?id=4730\r\n    var json = replacer || space ? JSON.stringify(value, replacer, space) : JSON.stringify(value);\r\n    if (escape) {\r\n        json = json.replace(/[<>&]/g, function (c) {\r\n            switch (c.charCodeAt(0)) {\r\n                case 0x3c:\r\n                    return \"\\\\u003c\";\r\n                case 0x3e:\r\n                    return \"\\\\u003e\";\r\n                case 0x26:\r\n                    return \"\\\\u0026\";\r\n                /* istanbul ignore next: unreachable default */\r\n                default:\r\n                    return c;\r\n            }\r\n        });\r\n    }\r\n    return json;\r\n}\r\n//# sourceMappingURL=response.js.map"]}