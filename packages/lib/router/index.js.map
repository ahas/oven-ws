{"version":3,"sources":["index.js"],"names":["__spreadArray","to","from","i","il","length","j","Route","Layer","methods","mixin","dbg","flatten","parseUrl","debug","objectRegExp","slice","Array","prototype","toString","Object","Router","options","opts","params","_params","caseSensitive","mergeParams","strict","stack","param","arg0","arg1","push","name","len","ret","Error","handle","req","res","out","self","method","url","idx","protohost","getProtohost","removed","slashAdded","calledParams","parentParams","parentUrl","baseUrl","done","restore","next","wrap","old","err","sendOptionsResponse","originalUrl","layerError","substr","setImmediate","path","getPathname","layer","match","route","matchLayer","hasMethod","_handles_method","appendMethods","_options","layerPath","process_params","handle_request","trim_prefix","c","substring","handle_error","called","keys","paramIndex","key","paramVal","paramCallbacks","paramCalled","undefined","error","value","paramCallback","fn","e","sensitive","end","dispatch","bind","use","offset","isArray","callbacks","call","arguments","TypeError","cb","getType","concat","forEach","apply","list","addition","indexOf","pathname","searchIndex","pathLength","fqdnIndex","obj","type","replace","parent","o","args","_i","props","vals","body","join","set","send","proxy"],"mappings":"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","file":"index.js","sourcesContent":["var __spreadArray = (this && this.__spreadArray) || function (to, from) {\r\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\r\n        to[j] = from[i];\r\n    return to;\r\n};\r\nimport Route from \"./route\";\r\nimport Layer from \"./layer\";\r\nimport methods from \"../methods\";\r\nimport mixin from \"utils-merge\";\r\nimport dbg from \"debug\";\r\nimport { flatten } from \"array-flatten\";\r\nimport parseUrl from \"parseurl\";\r\nvar debug = dbg(\"oven/ws:router\");\r\nvar objectRegExp = /^\\[object (\\S+)\\]$/;\r\nvar slice = Array.prototype.slice;\r\nvar toString = Object.prototype.toString;\r\nvar Router = /** @class */ (function () {\r\n    function Router(options) {\r\n        var opts = options || {};\r\n        this.params = {};\r\n        this._params = [];\r\n        this.caseSensitive = opts.caseSensitive;\r\n        this.mergeParams = opts.mergeParams;\r\n        this.strict = opts.strict;\r\n        this.stack = [];\r\n    }\r\n    Router.prototype.param = function (arg0, arg1) {\r\n        // param logic\r\n        if (typeof arg0 === \"function\") {\r\n            this._params.push(arg0);\r\n            return;\r\n        }\r\n        // apply param functions\r\n        var name = arg0;\r\n        var params = this._params;\r\n        var len = params.length;\r\n        var ret;\r\n        for (var i = 0; i < len; ++i) {\r\n            if ((ret = params[i](name, arg1))) {\r\n                arg1 = ret;\r\n            }\r\n        }\r\n        // ensure we end up with a\r\n        // middleware function\r\n        if (arg1 && typeof arg1 !== \"function\") {\r\n            throw new Error(\"invalid param() call for \" + name + \", got \" + arg1);\r\n        }\r\n        (this.params[name] = this.params[name] || []).push(arg1);\r\n        return this;\r\n    };\r\n    Router.prototype.handle = function (req, res, out) {\r\n        var self = this;\r\n        debug(\"dispatching %s %s\", req.method, req.url);\r\n        var idx = 0;\r\n        var protohost = getProtohost(req.url) || \"\";\r\n        var removed = \"\";\r\n        var slashAdded = false;\r\n        var calledParams = {};\r\n        // store options for OPTIONS request\r\n        // only used if OPTIONS request\r\n        var options = [];\r\n        // middleware and routes\r\n        var stack = self.stack;\r\n        // manage inter-router variables\r\n        var parentParams = req.params;\r\n        var parentUrl = req.baseUrl || \"\";\r\n        var done = restore(out, req, \"baseUrl\", \"next\", \"params\");\r\n        // setup next layer\r\n        req.next = next;\r\n        // for options requests, respond with a default if nothing else responds\r\n        if (req.method === \"OPTIONS\") {\r\n            done = wrap(done, function (old, err) {\r\n                if (err || options.length === 0) {\r\n                    return old(err);\r\n                }\r\n                sendOptionsResponse(res, options, old);\r\n            });\r\n        }\r\n        // setup basic req values\r\n        req.baseUrl = parentUrl;\r\n        req.originalUrl = req.originalUrl || req.url;\r\n        next();\r\n        function next(err) {\r\n            var layerError = err === \"route\" ? null : err;\r\n            // remove added slash\r\n            if (slashAdded) {\r\n                req.url = req.url.substr(1);\r\n                slashAdded = false;\r\n            }\r\n            // restore altered req.url\r\n            if (removed.length !== 0) {\r\n                req.baseUrl = parentUrl;\r\n                req.url = protohost + removed + req.url.substr(protohost.length);\r\n                removed = \"\";\r\n            }\r\n            // signal to exit router\r\n            if (layerError === \"router\") {\r\n                setImmediate(done, null);\r\n                return;\r\n            }\r\n            // no more matching layers\r\n            if (idx >= stack.length) {\r\n                setImmediate(done, layerError);\r\n                return;\r\n            }\r\n            // get pathname of request\r\n            var path = getPathname(req);\r\n            if (path == null) {\r\n                return done(layerError);\r\n            }\r\n            // find next matching layer\r\n            var layer;\r\n            var match;\r\n            var route;\r\n            while (match !== true && idx < stack.length) {\r\n                layer = stack[idx++];\r\n                match = matchLayer(layer, path);\r\n                route = layer.route;\r\n                if (typeof match !== \"boolean\") {\r\n                    // hold on to layerError\r\n                    layerError = layerError || match;\r\n                }\r\n                if (match !== true) {\r\n                    continue;\r\n                }\r\n                if (!route) {\r\n                    // process non-route handlers normally\r\n                    continue;\r\n                }\r\n                if (layerError) {\r\n                    // routes do not match with a pending error\r\n                    match = false;\r\n                    continue;\r\n                }\r\n                var method = req.method;\r\n                var hasMethod = route._handles_method(method);\r\n                // build up automatic options response\r\n                if (!hasMethod && method === \"OPTIONS\") {\r\n                    appendMethods(options, route._options());\r\n                }\r\n                // don't even bother matching route\r\n                if (!hasMethod && method !== \"HEAD\") {\r\n                    match = false;\r\n                    continue;\r\n                }\r\n            }\r\n            // no match\r\n            if (match !== true) {\r\n                return done(layerError);\r\n            }\r\n            // store route for dispatch on change\r\n            if (route) {\r\n                req.route = route;\r\n            }\r\n            // Capture one-time layer values\r\n            req.params = self.mergeParams ? mergeParams(layer.params, parentParams) : layer.params;\r\n            var layerPath = layer.path;\r\n            // this should be done for the layer\r\n            self.process_params(layer, calledParams, req, res, function (err) {\r\n                if (err) {\r\n                    return next(layerError || err);\r\n                }\r\n                if (route) {\r\n                    return layer.handle_request(req, res, next);\r\n                }\r\n                trim_prefix(layer, layerError, layerPath, path);\r\n            });\r\n        }\r\n        function trim_prefix(layer, layerError, layerPath, path) {\r\n            if (layerPath.length !== 0) {\r\n                // Validate path breaks on a path separator\r\n                var c = path[layerPath.length];\r\n                if (c && c !== \"/\" && c !== \".\")\r\n                    return next(layerError);\r\n                // Trim off the part of the url that matches the route\r\n                // middleware (.use stuff) needs to have the path stripped\r\n                debug(\"trim prefix (%s) from url %s\", layerPath, req.url);\r\n                removed = layerPath;\r\n                req.url = protohost + req.url.substr(protohost.length + removed.length);\r\n                // Ensure leading slash\r\n                if (!protohost && req.url[0] !== \"/\") {\r\n                    req.url = \"/\" + req.url;\r\n                    slashAdded = true;\r\n                }\r\n                // Setup base URL (no trailing slash)\r\n                req.baseUrl = parentUrl + (removed[removed.length - 1] === \"/\" ? removed.substring(0, removed.length - 1) : removed);\r\n            }\r\n            debug(\"%s %s : %s\", layer.name, layerPath, req.originalUrl);\r\n            if (layerError) {\r\n                layer.handle_error(layerError, req, res, next);\r\n            }\r\n            else {\r\n                layer.handle_request(req, res, next);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * Process any parameters for the layer.\r\n     */\r\n    Router.prototype.process_params = function (layer, called, req, res, done) {\r\n        var params = this.params;\r\n        // captured parameters from the layer, keys and values\r\n        var keys = layer.keys;\r\n        // fast track\r\n        if (!keys || keys.length === 0) {\r\n            return done();\r\n        }\r\n        var i = 0;\r\n        var name;\r\n        var paramIndex = 0;\r\n        var key;\r\n        var paramVal;\r\n        var paramCallbacks;\r\n        var paramCalled;\r\n        // process params in order\r\n        // param callbacks can be async\r\n        function param(err) {\r\n            if (err) {\r\n                return done(err);\r\n            }\r\n            if (i >= keys.length) {\r\n                return done();\r\n            }\r\n            paramIndex = 0;\r\n            key = keys[i++];\r\n            name = key.name;\r\n            paramVal = req.params[name];\r\n            paramCallbacks = params[name];\r\n            paramCalled = called[name];\r\n            if (paramVal === undefined || !paramCallbacks) {\r\n                return param();\r\n            }\r\n            // param previously called with same value or error occurred\r\n            if (paramCalled && (paramCalled.match === paramVal || (paramCalled.error && paramCalled.error !== \"route\"))) {\r\n                // restore value\r\n                req.params[name] = paramCalled.value;\r\n                // next param\r\n                return param(paramCalled.error);\r\n            }\r\n            called[name] = paramCalled = {\r\n                error: null,\r\n                match: paramVal,\r\n                value: paramVal,\r\n            };\r\n            paramCallback();\r\n        }\r\n        // single param callbacks\r\n        function paramCallback(err) {\r\n            var fn = paramCallbacks[paramIndex++];\r\n            // store updated value\r\n            paramCalled.value = req.params[key.name];\r\n            if (err) {\r\n                // store error\r\n                paramCalled.error = err;\r\n                param(err);\r\n                return;\r\n            }\r\n            if (!fn) {\r\n                return param();\r\n            }\r\n            try {\r\n                fn(req, res, paramCallback, paramVal, key.name);\r\n            }\r\n            catch (e) {\r\n                paramCallback(e);\r\n            }\r\n        }\r\n        param();\r\n    };\r\n    /**\r\n     * Create a new Route for the given path.\r\n     *\r\n     * Each route contains a separate middleware stack and VERB handlers.\r\n     *\r\n     * See the Route api documentation for details on adding handlers\r\n     * and middleware to routes.\r\n     *\r\n     * @param {String} path\r\n     * @return {Route}\r\n     * @public\r\n     */\r\n    Router.prototype.route = function (path) {\r\n        var route = new Route(path);\r\n        var layer = new Layer(path, {\r\n            sensitive: this.caseSensitive,\r\n            strict: this.strict,\r\n            end: true,\r\n        }, route.dispatch.bind(route));\r\n        layer.route = route;\r\n        this.stack.push(layer);\r\n        return route;\r\n    };\r\n    return Router;\r\n}());\r\nexport default Router;\r\nRouter.prototype.use = function (fn) {\r\n    var offset = 0;\r\n    var path = \"/\";\r\n    // default path to '/'\r\n    // disambiguate router.use([fn])\r\n    if (typeof fn !== \"function\") {\r\n        var arg0 = fn;\r\n        while (Array.isArray(arg0) && arg0.length !== 0) {\r\n            arg0 = arg0[0];\r\n        }\r\n        // first arg is the path\r\n        if (typeof arg0 !== \"function\") {\r\n            offset = 1;\r\n            path = fn;\r\n        }\r\n    }\r\n    var callbacks = flatten(slice.call(arguments, offset));\r\n    if (callbacks.length === 0) {\r\n        throw new TypeError(\"Router.use() requires a middleware function\");\r\n    }\r\n    for (var i = 0; i < callbacks.length; i++) {\r\n        var cb = callbacks[i];\r\n        if (typeof cb !== \"function\") {\r\n            throw new TypeError(\"Router.use() requires a middleware function but got a \" + getType(cb));\r\n        }\r\n        // add the middleware\r\n        debug(\"use %o %s\", path, cb.name || \"<anonymous>\");\r\n        var layer = new Layer(path, {\r\n            sensitive: this.caseSensitive,\r\n            strict: false,\r\n            end: false,\r\n        }, cb);\r\n        layer.route = undefined;\r\n        this.stack.push(layer);\r\n    }\r\n    return this;\r\n};\r\n// create Router#VERB functions\r\nmethods.concat(\"all\").forEach(function (method) {\r\n    Router.prototype[method] = function (path) {\r\n        var route = this.route(path);\r\n        route[method].apply(route, slice.call(arguments, 1));\r\n        return this;\r\n    };\r\n});\r\n// append methods to a list of methods\r\nfunction appendMethods(list, addition) {\r\n    for (var i = 0; i < addition.length; i++) {\r\n        var method = addition[i];\r\n        if (list.indexOf(method) === -1) {\r\n            list.push(method);\r\n        }\r\n    }\r\n}\r\n// get pathname of request\r\nfunction getPathname(req) {\r\n    try {\r\n        return parseUrl(req).pathname;\r\n    }\r\n    catch (err) {\r\n        return undefined;\r\n    }\r\n}\r\n// Get get protocol + host for a URL\r\nfunction getProtohost(url) {\r\n    if (typeof url !== \"string\" || url.length === 0 || url[0] === \"/\") {\r\n        return undefined;\r\n    }\r\n    var searchIndex = url.indexOf(\"?\");\r\n    var pathLength = searchIndex !== -1 ? searchIndex : url.length;\r\n    var fqdnIndex = url.substr(0, pathLength).indexOf(\"://\");\r\n    return fqdnIndex !== -1 ? url.substr(0, url.indexOf(\"/\", 3 + fqdnIndex)) : undefined;\r\n}\r\n// get type for error message\r\nfunction getType(obj) {\r\n    var type = typeof obj;\r\n    if (type !== \"object\") {\r\n        return type;\r\n    }\r\n    // inspect [[Class]] for objects\r\n    return toString.call(obj).replace(objectRegExp, \"$1\");\r\n}\r\n/**\r\n * Match path to a layer.\r\n *\r\n * @param {Layer} layer\r\n * @param {string} path\r\n * @private\r\n */\r\nfunction matchLayer(layer, path) {\r\n    try {\r\n        return layer.match(path);\r\n    }\r\n    catch (err) {\r\n        return err;\r\n    }\r\n}\r\n// merge params with parent params\r\nfunction mergeParams(params, parent) {\r\n    if (typeof parent !== \"object\" || !parent) {\r\n        return params;\r\n    }\r\n    // make copy of parent for base\r\n    var obj = mixin({}, parent);\r\n    // simple non-numeric merging\r\n    if (!(0 in params) || !(0 in parent)) {\r\n        return mixin(obj, params);\r\n    }\r\n    var i = 0;\r\n    var o = 0;\r\n    // determine numeric gaps\r\n    while (i in params) {\r\n        i++;\r\n    }\r\n    while (o in parent) {\r\n        o++;\r\n    }\r\n    // offset numeric indices in params before merge\r\n    for (i--; i >= 0; i--) {\r\n        params[i + o] = params[i];\r\n        // create holes for the merge when necessary\r\n        if (i < o) {\r\n            delete params[i];\r\n        }\r\n    }\r\n    return mixin(obj, params);\r\n}\r\n// restore obj props after function\r\nfunction restore(fn, obj) {\r\n    var args = [];\r\n    for (var _i = 2; _i < arguments.length; _i++) {\r\n        args[_i - 2] = arguments[_i];\r\n    }\r\n    var props = new Array(args.length);\r\n    var vals = new Array(args.length);\r\n    for (var i = 0; i < props.length; i++) {\r\n        props[i] = args[i];\r\n        vals[i] = obj[props[i]];\r\n    }\r\n    return function () {\r\n        // restore vals\r\n        for (var i = 0; i < props.length; i++) {\r\n            obj[props[i]] = vals[i];\r\n        }\r\n        return fn.apply(this, arguments);\r\n    };\r\n}\r\n// send an OPTIONS response\r\nfunction sendOptionsResponse(res, options, next) {\r\n    try {\r\n        var body = options.join(\",\");\r\n        res.set(\"Allow\", body);\r\n        res.send(body);\r\n    }\r\n    catch (err) {\r\n        next(err);\r\n    }\r\n}\r\n// wrap a function\r\nfunction wrap(old, fn) {\r\n    return function proxy() {\r\n        fn.apply(this, __spreadArray([old], Array.from(arguments)));\r\n    };\r\n}\r\n//# sourceMappingURL=index.js.map"]}