{"version":3,"sources":["layer.js"],"names":["pathToRegexp","dbg","debug","hasOwnProperty","Object","prototype","decode_param","val","length","decodeURIComponent","err","URIError","message","status","Layer","path","options","fn","opts","handle","name","params","undefined","regexp","keys","fast_star","fast_slash","end","handle_error","error","req","res","next","handle_request","match","exec","i","key","prop","call"],"mappings":"AAAA,SAASA,YAAT,QAA6B,gBAA7B;AACA,OAAOC,GAAP,MAAgB,OAAhB;AACA,IAAIC,QAAQD,IAAI,sBAAJ,CAAZ;AACA,IAAIE,iBAAiBC,OAAOC,SAAP,CAAiBF,cAAtC;AACA,SAASG,YAAT,CAAsBC,GAAtB,EAA2B;AACvB,QAAI,OAAOA,GAAP,KAAe,QAAf,IAA2BA,IAAIC,MAAJ,KAAe,CAA9C,EAAiD;AAC7C,eAAOD,GAAP;AACH;AACD,QAAI;AACA,eAAOE,mBAAmBF,GAAnB,CAAP;AACH,KAFD,CAGA,OAAOG,GAAP,EAAY;AACR,YAAIA,eAAeC,QAAnB,EAA6B;AACzBD,gBAAIE,OAAJ,GAAc,6BAA6BL,GAA7B,GAAmC,GAAjD;AACAG,gBAAIG,MAAJ,GAAa,GAAb;AACH;AACD,cAAMH,GAAN;AACH;AACJ;AACD,IAAII,QAAQ,aAAe,YAAY;AACnC,aAASA,KAAT,CAAeC,IAAf,EAAqBC,OAArB,EAA8BC,EAA9B,EAAkC;AAC9Bf,cAAM,QAAN,EAAgBa,IAAhB;AACA,YAAIG,OAAOF,WAAW,EAAtB;AACA,aAAKG,MAAL,GAAcF,EAAd;AACA,aAAKG,IAAL,GAAYH,GAAGG,IAAH,IAAW,aAAvB;AACA,aAAKC,MAAL,GAAcC,SAAd;AACA,aAAKP,IAAL,GAAYO,SAAZ;AACA,aAAKC,MAAL,GAAcvB,aAAae,IAAb,EAAoB,KAAKS,IAAL,GAAY,EAAhC,EAAqCN,IAArC,CAAd;AACA;AACA,aAAKK,MAAL,CAAYE,SAAZ,GAAwBV,SAAS,EAAjC;AACA,aAAKQ,MAAL,CAAYG,UAAZ,GAAyBX,SAAS,GAAT,IAAgBG,KAAKS,GAAL,KAAa,KAAtD;AACH;AACDb,UAAMT,SAAN,CAAgBuB,YAAhB,GAA+B,UAAUC,KAAV,EAAiBC,GAAjB,EAAsBC,GAAtB,EAA2BC,IAA3B,EAAiC;AAC5D,YAAIf,KAAK,KAAKE,MAAd;AACA,YAAIF,GAAGT,MAAH,KAAc,CAAlB,EAAqB;AACjB;AACA,mBAAOwB,KAAKH,KAAL,CAAP;AACH;AACD,YAAI;AACAZ,eAAGY,KAAH,EAAUC,GAAV,EAAeC,GAAf,EAAoBC,IAApB;AACH,SAFD,CAGA,OAAOtB,GAAP,EAAY;AACRsB,iBAAKtB,GAAL;AACH;AACJ,KAZD;AAaAI,UAAMT,SAAN,CAAgB4B,cAAhB,GAAiC,UAAUH,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACvD,YAAIf,KAAK,KAAKE,MAAd;AACA,YAAIF,GAAGT,MAAH,GAAY,CAAhB,EAAmB;AACf;AACA,mBAAOwB,MAAP;AACH;AACD,YAAI;AACAf,eAAGa,GAAH,EAAQC,GAAR,EAAaC,IAAb;AACH,SAFD,CAGA,OAAOtB,GAAP,EAAY;AACRsB,iBAAKtB,GAAL;AACH;AACJ,KAZD;AAaA;;;;;;;AAOAI,UAAMT,SAAN,CAAgB6B,KAAhB,GAAwB,UAAUnB,IAAV,EAAgB;AACpC,YAAImB,KAAJ;AACA,YAAInB,QAAQ,IAAZ,EAAkB;AACd;AACA,gBAAI,KAAKQ,MAAL,CAAYG,UAAhB,EAA4B;AACxB,qBAAKL,MAAL,GAAc,EAAd;AACA,qBAAKN,IAAL,GAAY,EAAZ;AACA,uBAAO,IAAP;AACH;AACD;AACA,gBAAI,KAAKQ,MAAL,CAAYE,SAAhB,EAA2B;AACvB,qBAAKJ,MAAL,GAAc,EAAE,GAAGf,aAAaS,IAAb,CAAL,EAAd;AACA,qBAAKA,IAAL,GAAYA,IAAZ;AACA,uBAAO,IAAP;AACH;AACD;AACAmB,oBAAQ,KAAKX,MAAL,CAAYY,IAAZ,CAAiBpB,IAAjB,CAAR;AACH;AACD,YAAI,CAACmB,KAAL,EAAY;AACR,iBAAKb,MAAL,GAAcC,SAAd;AACA,iBAAKP,IAAL,GAAYO,SAAZ;AACA,mBAAO,KAAP;AACH;AACD;AACA,aAAKD,MAAL,GAAc,EAAd;AACA,aAAKN,IAAL,GAAYmB,MAAM,CAAN,CAAZ;AACA,YAAIV,OAAO,KAAKA,IAAhB;AACA,YAAIH,SAAS,KAAKA,MAAlB;AACA,aAAK,IAAIe,IAAI,CAAb,EAAgBA,IAAIF,MAAM1B,MAA1B,EAAkC4B,GAAlC,EAAuC;AACnC,gBAAIC,MAAMb,KAAKY,IAAI,CAAT,CAAV;AACA,gBAAIE,OAAOD,IAAIjB,IAAf;AACA,gBAAIb,MAAMD,aAAa4B,MAAME,CAAN,CAAb,CAAV;AACA,gBAAI7B,QAAQe,SAAR,IAAqB,CAACnB,eAAeoC,IAAf,CAAoBlB,MAApB,EAA4BiB,IAA5B,CAA1B,EAA6D;AACzDjB,uBAAOiB,IAAP,IAAe/B,GAAf;AACH;AACJ;AACD,eAAO,IAAP;AACH,KArCD;AAsCA,WAAOO,KAAP;AACH,CArF0B,EAA3B;AAsFA,eAAeA,KAAf;AACA","file":"layer.js","sourcesContent":["import { pathToRegexp } from \"path-to-regexp\";\r\nimport dbg from \"debug\";\r\nvar debug = dbg(\"oven/ws:router:layer\");\r\nvar hasOwnProperty = Object.prototype.hasOwnProperty;\r\nfunction decode_param(val) {\r\n    if (typeof val !== \"string\" || val.length === 0) {\r\n        return val;\r\n    }\r\n    try {\r\n        return decodeURIComponent(val);\r\n    }\r\n    catch (err) {\r\n        if (err instanceof URIError) {\r\n            err.message = \"Failed to decode param '\" + val + \"'\";\r\n            err.status = 400;\r\n        }\r\n        throw err;\r\n    }\r\n}\r\nvar Layer = /** @class */ (function () {\r\n    function Layer(path, options, fn) {\r\n        debug(\"new %o\", path);\r\n        var opts = options || {};\r\n        this.handle = fn;\r\n        this.name = fn.name || \"<anonymous>\";\r\n        this.params = undefined;\r\n        this.path = undefined;\r\n        this.regexp = pathToRegexp(path, (this.keys = []), opts);\r\n        // set fast path flags\r\n        this.regexp.fast_star = path === \"\";\r\n        this.regexp.fast_slash = path === \"/\" && opts.end === false;\r\n    }\r\n    Layer.prototype.handle_error = function (error, req, res, next) {\r\n        var fn = this.handle;\r\n        if (fn.length !== 4) {\r\n            // not a standard error handler\r\n            return next(error);\r\n        }\r\n        try {\r\n            fn(error, req, res, next);\r\n        }\r\n        catch (err) {\r\n            next(err);\r\n        }\r\n    };\r\n    Layer.prototype.handle_request = function (req, res, next) {\r\n        var fn = this.handle;\r\n        if (fn.length > 3) {\r\n            // not a standard request handler\r\n            return next();\r\n        }\r\n        try {\r\n            fn(req, res, next);\r\n        }\r\n        catch (err) {\r\n            next(err);\r\n        }\r\n    };\r\n    /**\r\n     * Check if this route matches `path`, if so\r\n     * populate `.params`.\r\n     *\r\n     * @param {String} path\r\n     * @return {Boolean}\r\n     */\r\n    Layer.prototype.match = function (path) {\r\n        var match;\r\n        if (path != null) {\r\n            // fast path non-ending match for / (any path matches)\r\n            if (this.regexp.fast_slash) {\r\n                this.params = {};\r\n                this.path = \"\";\r\n                return true;\r\n            }\r\n            // fast path for * (everything matched in a param)\r\n            if (this.regexp.fast_star) {\r\n                this.params = { 0: decode_param(path) };\r\n                this.path = path;\r\n                return true;\r\n            }\r\n            // match the path\r\n            match = this.regexp.exec(path);\r\n        }\r\n        if (!match) {\r\n            this.params = undefined;\r\n            this.path = undefined;\r\n            return false;\r\n        }\r\n        // store values\r\n        this.params = {};\r\n        this.path = match[0];\r\n        var keys = this.keys;\r\n        var params = this.params;\r\n        for (var i = 1; i < match.length; i++) {\r\n            var key = keys[i - 1];\r\n            var prop = key.name;\r\n            var val = decode_param(match[i]);\r\n            if (val !== undefined || !hasOwnProperty.call(params, prop)) {\r\n                params[prop] = val;\r\n            }\r\n        }\r\n        return true;\r\n    };\r\n    return Layer;\r\n}());\r\nexport default Layer;\r\n//# sourceMappingURL=layer.js.map"]}